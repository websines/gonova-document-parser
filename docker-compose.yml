version: '3.8'

# Document Parser API - Connects to external services
# Prerequisites:
# - vLLM servers running at localhost:4444, 4445, 4446
# - Redis running at localhost:6379

services:
  # Document Processing API Server
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: docparser-api
    ports:
      - "8080:8080"
    environment:
      # API Configuration
      - HOST=0.0.0.0
      - PORT=8080
      - WORKERS=1

      # Processing Configuration
      - DEFAULT_ACCURACY_MODE=balanced
      - INFERENCE_MODE=vllm
      - ENABLE_ENRICHMENT=true

      # External vLLM Endpoints (running on host)
      - VLLM_DEEPSEEK_URL=http://host.docker.internal:4444/v1/chat/completions
      - VLLM_NANONETS_URL=http://host.docker.internal:4445/v1/chat/completions
      - VLLM_GRANITE_URL=http://host.docker.internal:4446/v1/chat/completions
      - VLLM_API_KEY=EMPTY

      # External Redis (running on host)
      - REDIS_URL=redis://host.docker.internal:6379/0

      # No GPU needed for API (vLLM runs externally)
      - TORCH_DEVICE=cpu
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
    extra_hosts:
      - "host.docker.internal:host-gateway"

# ==============================================================================
# Usage Instructions
# ==============================================================================
#
# Prerequisites:
# - vLLM servers running on host at ports 4444, 4445, 4446
# - Redis running on host at port 6379
#
# Start the API server:
#   docker compose up -d
#
# Or run directly (no Docker):
#   uvicorn document_parser.api:app --host 0.0.0.0 --port 8080
#
# Check logs:
#   docker compose logs -f api
#
# Access API:
#   - API: http://localhost:8080
#   - Docs: http://localhost:8080/docs
#   - Health: http://localhost:8080/health
#
# Stop:
#   docker compose down
#
# ==============================================================================
